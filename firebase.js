import admin from "firebase-admin";

/**
 * HOW TO USE:
 * 1. Put your base64 key in Railway env as:
 *    FIREBASE_ADMIN_B64=xxxx
 *
 * 2. OR (local fallback) paste base64 below
 */

// OPTIONAL LOCAL FALLBACK (only if env is missing)
 const LOCAL_FIREBASE_ADMIN_B64 = "ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAidHJ1ZS1hZHMtYTA1M2EiLAogICJwcml2YXRlX2tleV9pZCI6ICJlMDRmM2IyMzZhM2VjNzZkNmNhYTMwNjZkYzIyNjUwMjUwMzIxOWMwIiwKICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdlFJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLY3dnZ1NqQWdFQUFvSUJBUURGWmVLalJ1MFVFL0FIXG43UTN3ZUhsM2k2RkcyWjZ0bzBoelFVU2IyRGVQQS9mRUtRcUg2ejlRSjZkQ0k1dytpS1FRSGxBeEFqVy9CT1J4XG5VU2hJaUxVcVQxRjVjTW9CWk5IcTBNdm1RaFQxbks3OXo4VXhBeXZWSUhqVy9VTDJLM2FQbC9jcVdkaHNMeFZaXG5QTG9yKy9aTzk4YlE3N1p6M05ic2FaRXdQMXU2UFhwSlEyNlJuMU1JMXl5TGpuem51N1FKTjRZUlViM2drNWVMXG5iTUN3VDUzREJaT05ZdkU1MENnZmdpVmRNcmVSbEdET0NGVkd3VHo4VHRuRzQ3cXpXYUhSL29DVkZDOUQyTXArXG5Pa2ttckNaNjN3RFNiNVZoWFhNR2tmYzBjQzZqdHo3SHptTy9BTTB4ZjNEdHlCYk5tYzF6d0VDV3RHZFhKQWVUXG51SWhML3FyTEFnTUJBQUVDZ2dFQUdsZHR4bjhjL1B4cUlBeWt1dzNBbTlEUXZUMG1IU0s0ZE5UbFhHeWVnV0cwXG5xd01WQ2kwODNpdmtlSUY3QktkRVNYaGFHQ2drMXZCR3NjNTBNelczQTBYaFovVENxQ3YxalVHK3ErUHVteFlGXG5EZzZ2VUVxTmkxdlJkRk1Jb0FRTnhyeXZPWUlTek9EOWx0SnhQNVJZZXBJN0FEKzAxOEpGRmZoQ2JTOVBSTXRhXG5JeDlSc05FVnlRRHJpcjI2QlNLTjdHTEZWL0p2d0RtaGJFa25QR2FPVjNySCtSUnpsc2QvZFFSdi9uZ0ZmR2lCXG5lck1nbzJWR3VoQ1RQQi9xY0krNjY4MUxZb2NNVDNZY3lMTUwvOWI3SjdFTHFrelVCSDk4b1BDYUFhRXQvL3lHXG5hb01VcFUzTGVxSWNuMEU0OXVxOWNTY1BOc2IwNzZUWDR6NURLdVZCUFFLQmdRRDNqaHAydFlnOCtrL0pCaU45XG5FUUhMLytrVWp2T0pibHJBUmt6U3FOaDFVblVxSWRUa24yalhPSUlMWmU0OCtVVmlaMGZ1bFRoMHF6Q25GYllmXG5QWlVtVzhZUGcvQjA3ZU1KaHJWUTZUL0t1eVhjWDNsU3ZIY2k0ZkdTSG9nRmIvbXVWeG1TZlhHYVNpVnZYVlRVXG4yWlhMUERGdk03Zi90UkZBdFZLZGhIc0dIUUtCZ1FETUljS25HQUNXWmVvOVdIS3d1RmJuOXdVdTJaN0dCdGNuXG52ZUtMblUwaGNVNlVlODJiM29DM3BiWTdrcmVRV0tSTDFiK2xFbVlFcHNueG9QaTVvK3kvSng3bGJkeDRMaXFyXG50TVRrOCsrZGRiOGFmSVQvTk1IN2lLL1NxTVpSaU1wRmJkMzBjZFM2QnJxTmoveUY3d3hML0hGUXdUa0pNckwzXG56eS9USDIrQUJ3S0JnUUMwWGg4OStzb0cwOElxRDRUdjdPSklSbThHZ1psRHV0bjRXY0JEaEs0aDNUQnN3RFdqXG5WZHBIWlc2cTYxdUhwWDgrVVU0QnNVdHZCZ1B1MlV6V3VrSGZydUpDRDdtMUdGWmhiSHJUTnY4NXNOM0hFUEVPXG5yUzZJaGVOQ3VXZ1Z2aDVIUGtMdGp1U2txLzFXaE1QNFNZaHdpYXppL3VYRE02UWNaNENJTUN5S3FRS0JnRkNzXG40dzVBeVRLbmNxenVBTjNnN00vZWE1ajVmdXVLbG92cFd0aU13WWYvRE94WUJZbWRwVWR2WVpjbnhBNXpTZk9DXG50YXdhbW1FcVBkT1dKOWJPZDJtUW40QlRLL2YvWHZQZmpKVmo1d1pYRzhEdkIyMEpQOFVXWDA2bFQwTzRDU0RwXG5hL2dJNk9iZ2MrZ3d5TDl5RzIwSWh3eEFZVGRHWno3VERuYWxETjhQQW9HQVgvaTIxdktTVXYxSW03QUN6SGViXG5HVHFXT0FDTzFLVGJRdlJMemN0NjFPUjFZRVBZTHlVM0hTSU81dnRidGtRQUdvVWxrSmRnWVl3NXROejdHMHNKXG5PTXg0czRLbjZyVlRobHVNZjIrelFFSTFOek5nemhqRFNSMFA5cktvdFYzbGdENXdpYTJQQ2RnOFYyN1dZUExYXG4ySlhjVFhJT3lNN0RFYmhXcDhyRTRkVT1cbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsCiAgImNsaWVudF9lbWFpbCI6ICJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0B0cnVlLWFkcy1hMDUzYS5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgImNsaWVudF9pZCI6ICIxMDExNDkxNDcwNzE3MTE1Mjg0MzAiLAogICJhdXRoX3VyaSI6ICJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20vby9vYXV0aDIvYXV0aCIsCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsCiAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICJjbGllbnRfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9yb2JvdC92MS9tZXRhZGF0YS94NTA5L2ZpcmViYXNlLWFkbWluc2RrLWZic3ZjJTQwdHJ1ZS1hZHMtYTA1M2EuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K";

const b64 =
  process.env.FIREBASE_ADMIN_B64
   || LOCAL_FIREBASE_ADMIN_B64
;

if (!b64) {
  throw new Error("FIREBASE_ADMIN_B64 env variable is missing");
}

const serviceAccount = JSON.parse(
  Buffer.from(b64, "base64").toString("utf8")
);

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
  });
}

export const db = admin.firestore();
export const auth = admin.auth();
export default admin;
